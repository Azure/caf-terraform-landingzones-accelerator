- name: set asvm context
  set_fact:
    asvm_folder: "{{ asvm_long_folder if 'path' not in asvm_long_folder else asvm_long_folder.path | regex_search('[^\/]+(?=\/$|$)') }}"

- name: "[{{ level }}-{{ asvm_folder }}] Set cache folder"
  set_fact:
    job_cache_base_path: "/home/vscode/.terraform.cache"
    subscription_key: "{{ asvm_folder }}"

#### Get subscription_id

- name: "[{{ level }} {{ subscription_key }}] - subscription"
  include_tasks: "{{ level }}/ansible-subscription-id.yaml"
  when: config.tfstates['asvm'][subscription_key].subscription.subscription_id is not defined

### Subscription

- name: set destination paths
  set_fact:
    destination_path:  "{{ destination_base_path }}/{{ subscription_key }}/subscription"

- name: "Clean-up directory - subscription - {{ destination_path }}"
  file:
    path: "{{ destination_path }}"
    state: absent
  when: config.configuration_folders.asvm.cleanup_destination  | default(true) | bool

- name: "[{{ level }} {{ subscription_key }}] - subscription"
  include_tasks: "{{ level }}/ansible-subscription.yaml"
  when: config.tfstates['asvm'][subscription_key].subscription.subscription_id is not defined


#### Resources

- name: set destination paths
  set_fact:
    destination_path:  "{{ destination_base_path }}/{{ subscription_key }}/resources"

- name: "Clean-up directory - subscription - {{ destination_path }}"
  file:
    path: "{{ destination_path }}"
    state: absent
  when: config.configuration_folders.asvm.cleanup_destination  | default(true) | bool

- name: "[{{ level }} {{ subscription_key }}] - resources"
  include_tasks: "{{ level }}/ansible-resources.yaml"
  when: 
    - resources.subscriptions[subscription_key] is defined
