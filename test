export TF_VAR_workspace=secureaks

-tfstate caf_foundations.tfstate \
-level level0 \
-launchpad \

-launchpad \


id=$(az storage account list --query "[?tags.tfstate=='level0' && tags.launchpad=='launchpad']" -o json | jq -r .[0].id)

if [ "${id}" == "null" ]; then 
    git clone https://github.com/Azure/caf-terraform-landingzones.git /tf/caf/public
    /tf/rover/rover.sh -lz /tf/caf/public/landingzones/caf_launchpad -a apply -launchpad -var-folder /tf/caf/enterprise_scale/construction_sets/aks/online/aks_secure_baseline/levels/launchpad
fi    

/tf/rover/rover.sh -lz /tf/caf/enterprise_scale/construction_sets/aks \
     -a apply \
     -level level1 \
     -tfstate  secure-aks-foundations.tfstate \
     '-var-file online/aks_secure_baseline/configuration/global_settings.tfvars -var-file online/aks_secure_baseline/configuration/resource_groups.tfvars -var-file online/aks_secure_baseline/configuration/iam/iam_managed_identities.tfvars -var-file online/aks_secure_baseline/configuration/iam/iam_role_mappings.tfvars -var-file online/aks_secure_baseline/configuration/keyvault/keyvaults.tfvars'

/tf/rover/rover.sh -lz /tf/caf/enterprise_scale/construction_sets/aks \
     -a apply \
     -level level2 \
     -tfstate  secure-aks-foundations.tfstate \
     '-var-file online/aks_secure_baseline/configuration/monitor/diagnostics.tfvars -var-file online/aks_secure_baseline/configuration/monitor/log_analytics.tfvars'



/tf/rover/rover.sh -lz /tf/caf/enterprise_scale/construction_sets/aks \
     -a apply \
     -level level2 \
     -tfstate  secure-aks-shared-services.tfstate \
     '-var-file online/aks_secure_baseline/configuration/global_settings.tfvars -var-file online/aks_secure_baseline/configuration/resource_groups.tfvars -var-file online/aks_secure_baseline/configuration/monitor/diagnostics.tfvars -var-file online/aks_secure_baseline/configuration/monitor/log_analytics.tfvars'

/tf/rover/rover.sh -lz /tf/caf/enterprise_scale/construction_sets/aks \
     -a apply \
     -level level2 \
     -tfstate  2_networking.tfstate \
     '-var-file online/aks_secure_baseline/configuration/global_settings.tfvars -var-file online/aks_secure_baseline/configuration/resource_groups.tfvars -var-file online/aks_secure_baseline/configuration/networking/firewall_application_rule_collection_definition.tfvars -var-file online/aks_secure_baseline/configuration/networking/firewall_network_rule_collection_definition.tfvars -var-file online/aks_secure_baseline/configuration/networking/firewalls.tfvars -var-file online/aks_secure_baseline/configuration/networking/ip_groups.tfvars -var-file online/aks_secure_baseline/configuration/networking/networking.tfvars -var-file online/aks_secure_baseline/configuration/networking/nsg.tfvars -var-file online/aks_secure_baseline/configuration/networking/peerings.tfvars -var-file online/aks_secure_baseline/configuration/networking/private_dns.tfvars -var-file online/aks_secure_baseline/configuration/networking/public_ips.tfvars -var-file online/aks_secure_baseline/configuration/networking/route_tables.tfvars -var-file online/aks_secure_baseline/configuration/agw/agw_application.tfvars -var-file online/aks_secure_baseline/configuration/agw/agw.tfvars -var-file online/aks_secure_baseline/configuration/agw/domain.tfvars -var-file online/aks_secure_baseline/configuration/keyvault/keyvaults.tfvars -var-file online/aks_secure_baseline/configuration/keyvault/certificate_requests.tfvars -var-file online/aks_secure_baseline/configuration/iam/iam_managed_identities.tfvars'



for rgname in `az group list --query "[? contains(name,'-ef-')][].{name:name}" -o tsv`; do
echo Deleting ${rgname}
az group delete -n ${rgname} --yes --no-wait
done



global_settings={"prfix":"yes"}