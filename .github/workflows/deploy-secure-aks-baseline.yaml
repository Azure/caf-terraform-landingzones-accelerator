name: Deploy_Seccure_Aks_Baseline
# The pipeline is triggered on:
#  - PR/Issue comments "/deploy-all", "/deploy-lunchpad", "/deploy-foundation", "/deploy-networking",
#                      "/deploy-shared-services", "/deploy-aks"

on:
  issue_comment:
    types: [created]

env:
  AZURE_CREDENTIALS: '{"clientId":"${{ secrets.SERVICE_PRINCIPAL }}", "clientSecret":"${{ secrets.SERVICE_PRINCIPAL_PWD }}", "subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}", "tenantId":"${{ secrets.TENANT }}"}' 

jobs:
  prepare_code:

    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '/deploy-') 
    outputs:
      event_sha: ${{ env.event_sha }}
    steps:
      # - uses: actions/checkout@v2
      - name: GetPRSHA
        if: github.event_name == 'issue_comment'
        run: echo "::set-env name=event_sha::+refs/pull/${{ github.event.issue.number }}/merge"
      - name: GetREFSHA
        if: github.event_name != 'issue_comment'
        run: echo "::set-env name=event_sha::${{ github.ref }}"

  deploy-lunchpad:
    runs-on: ubuntu-latest
    needs: prepare_code
    steps:
      - name: Checkout PR code
        if: contains(github.event.comment.body, '/deploy-all') || contains(github.event.comment.body, '/deploy-lunchpad')
        run: |
          git fetch origin ${{ env.event_sha }}
          git checkout FETCH_HEAD

      - name: Azure Login
        if: contains(github.event.comment.body, '/deploy-all') || contains(github.event.comment.body, '/deploy-lunchpad')      
        uses: azure/login@v1
        with:
          creds: ${{ env.AZURE_CREDENTIALS }}

      - name: Deploy
        if: contains(github.event.comment.body, '/deploy-all') || contains(github.event.comment.body, '/deploy-lunchpad')      
        uses: azure/CLI@v1
        with:
          inlineScript: |          
            cd $GITHUB_WORKSPACE/enterprise_scale/construction_sets/aks
            deploy-level.sh 0_lunchpad

      - name: Test
        if: contains(github.event.comment.body, '/deploy-all') || contains(github.event.comment.body, '/deploy-lunchpad')      
        uses: azure/CLI@v1
        with:
          inlineScript: |          
            echo "Invoke integration test"
